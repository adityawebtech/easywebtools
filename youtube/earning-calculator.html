<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YouTube Earnings Estimator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4 text-center">ðŸ“º YouTube Earnings Estimator</h1>

    <form id="earningForm" class="space-y-4 bg-white p-6 rounded shadow">
      <input id="channelInput" type="text" placeholder="Enter YouTube Channel or Video URL"
        class="w-full p-3 border rounded focus:outline-none focus:ring focus:ring-blue-300" required>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <input id="customViews" type="number" placeholder="Optional: Views per month"
          class="w-full p-3 border rounded focus:outline-none focus:ring focus:ring-blue-300">
        <input id="customCPM" type="number" step="0.01" placeholder="Optional: CPM ($)"
          class="w-full p-3 border rounded focus:outline-none focus:ring focus:ring-blue-300">
      </div>

      <button type="submit"
        class="w-full bg-blue-600 text-white p-3 rounded font-semibold hover:bg-blue-700">Estimate Earnings</button>
    </form>

    <div id="earningResults" class="hidden mt-10 bg-white p-6 rounded shadow space-y-6">
      <div id="channelName"></div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
        <div class="bg-yellow-100 p-4 rounded shadow">
          <div class="text-sm text-gray-600">Estimated Daily</div>
          <div id="dailyEarning" class="text-xl font-bold">-</div>
        </div>
        <div class="bg-green-100 p-4 rounded shadow">
          <div class="text-sm text-gray-600">Estimated Monthly</div>
          <div id="monthlyEarning" class="text-xl font-bold">-</div>
        </div>
        <div class="bg-blue-100 p-4 rounded shadow">
          <div class="text-sm text-gray-600">Estimated Yearly</div>
          <div id="yearlyEarning" class="text-xl font-bold">-</div>
        </div>
      </div>

      <div id="infoUsed" class="text-sm text-gray-600"></div>

      <canvas id="earningsChart" height="150"></canvas>
    </div>
  </div>

  <script>
    const BACKEND_URL = "https://yt-meta-backend.onrender.com";

    const currencySymbols = {
      US: '$', IN: 'â‚¹', GB: 'Â£', JP: 'Â¥', CA: '$', AU: '$', EU: 'â‚¬',
      DE: 'â‚¬', FR: 'â‚¬', IT: 'â‚¬', ES: 'â‚¬', default: '$'
    };

    document.getElementById('earningForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const urlInput = document.getElementById('channelInput').value.trim();
      const customCPM = parseFloat(document.getElementById('customCPM').value);
      const customViews = parseInt(document.getElementById('customViews').value);

      try {
        const idRes = await fetch(`${BACKEND_URL}/api/channel-id?url=${encodeURIComponent(urlInput)}`);
        const idData = await idRes.json();
        if (!idData.channelId) throw new Error("Invalid or unsupported YouTube URL.");

        const channelRes = await fetch(`${BACKEND_URL}/api/earnings?channelId=${idData.channelId}`);
        const channelData = await channelRes.json();
        if (channelData.error) throw new Error(channelData.error);

        const {
          channelTitle, thumbnail, subscriberCount, totalViews, videoCount,
          estimatedEarningsLow, estimatedEarningsHigh, avgEarning, country
        } = channelData;

        const currency = currencySymbols[country] || currencySymbols.default;
        const usedViewsPerMonth = customViews || totalViews;
        const usedCPM = customCPM || 1.5;

        const daily = ((usedViewsPerMonth / 30) / 1000 * usedCPM).toFixed(2);
        const monthly = ((usedViewsPerMonth / 1000) * usedCPM).toFixed(2);
        const yearly = ((usedViewsPerMonth * 12 / 1000) * usedCPM).toFixed(2);

        document.getElementById('channelName').innerHTML = `
          <div class="flex items-center gap-4">
            <img src="${thumbnail}" class="w-12 h-12 rounded-full border" alt="${channelTitle}">
            <div>
              <div class="font-semibold">${channelTitle}</div>
              <div class="text-sm text-gray-500">Country: ${country || 'N/A'}</div>
            </div>
          </div>
        `;

        document.getElementById('dailyEarning').textContent = `${currency} ${daily}`;
        document.getElementById('monthlyEarning').textContent = `${currency} ${monthly}`;
        document.getElementById('yearlyEarning').textContent = `${currency} ${yearly}`;

        document.getElementById('infoUsed').innerHTML = `
          <div><strong>Used Views/Month:</strong> ${usedViewsPerMonth.toLocaleString()}</div>
          <div><strong>Used CPM:</strong> ${currency} ${usedCPM.toFixed(2)}</div>
        `;

        const ctx = document.getElementById('earningsChart').getContext('2d');
        if (window.earningChart) window.earningChart.destroy();
        window.earningChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Daily', 'Monthly', 'Yearly'],
            datasets: [{
              label: `Earnings in ${currency}`,
              data: [daily, monthly, yearly],
              backgroundColor: ['#fbbf24', '#4ade80', '#60a5fa']
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });

        document.getElementById('earningResults').classList.remove('hidden');
        document.getElementById('earningResults').scrollIntoView({ behavior: 'smooth' });

      } catch (err) {
        console.error(err);
        alert("Error: " + err.message);
      }
    });
  </script>

</body>
</html>
